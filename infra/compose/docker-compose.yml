version: '3.8'

services:
  traefik:
    image: traefik:v3.0
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --entryPoints.web.address=:80
    ports:
      - "80:80"
      - "8080:8080" # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  backend:
    build:
      context: ../..
      dockerfile: apps/backend/Dockerfile
    environment:
      - PORT=3000
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=PathPrefix(`/api`) || PathPrefix(`/ws`)"
      - "traefik.http.routers.backend.entrypoints=web"
      - "traefik.http.services.backend.loadbalancer.server.port=3000"

  web:
    build:
      context: ../..
      dockerfile: apps/web/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=PathPrefix(`/`)"
      - "traefik.http.routers.web.entrypoints=web"
      - "traefik.http.routers.web.priority=1"

  admin:
    build:
      context: ../..
      dockerfile: apps/admin/Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.admin-strip.stripprefix.prefixes=/admin"
      - "traefik.http.routers.admin.rule=PathPrefix(`/admin`)"
      - "traefik.http.routers.admin.entrypoints=web"
      - "traefik.http.routers.admin.middlewares=admin-strip"
      - "traefik.http.routers.admin.priority=2"
      - "traefik.http.services.admin.loadbalancer.server.port=80"

  bot:
    build:
      context: ../..
      dockerfile: apps/bot/Dockerfile
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    # No HTTP exposure

  mcp:
    build:
      context: ../..
      dockerfile: services/mcp/Dockerfile
    environment:
      - MCP_PORT=8080
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp.rule=PathPrefix(`/mcp`)"
      - "traefik.http.routers.mcp.entrypoints=web"
      - "traefik.http.services.mcp.loadbalancer.server.port=8080"

networks:
  default:
    name: raid-net
